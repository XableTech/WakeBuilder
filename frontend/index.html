<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WakeBuilder - Wake Word Training Platform</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-brand">
            <svg class="nav-logo" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                <line x1="12" y1="19" x2="12" y2="23" />
                <line x1="8" y1="23" x2="16" y2="23" />
            </svg>
            <span>WakeBuilder</span>
        </div>
        <div class="nav-links">
            <a href="#" class="nav-link active" data-page="home">Models</a>
            <a href="#" class="nav-link" data-page="train">Train</a>
            <a href="#" class="nav-link" data-page="test">Test</a>
            <a href="/docs" class="nav-link" target="_blank">API Docs</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <!-- Home Page: Model Library -->
        <section id="page-home" class="page active">
            <div class="page-header">
                <h1>Wake Word Models</h1>
                <button class="btn btn-primary" id="btn-new-model">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19" />
                        <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                    Train New Model
                </button>
            </div>

            <div class="model-filters">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="custom">Custom</button>
                <button class="filter-btn" data-filter="default">Default</button>
            </div>

            <!-- Negative Data Status Panel (shown when data is missing) -->
            <div class="cache-panel-prominent cache-missing" id="negative-data-panel" style="display: none;">
                <h4>‚ö†Ô∏è Negative Data Required <span class="required-badge">Missing</span></h4>
                <p class="cache-description">
                    Negative audio samples are required for training. These are audio files that do NOT contain your
                    wake word.
                    The UNAC (Universal Negative Audio Corpus) dataset will provide diverse audio samples.
                </p>
                <div class="cache-info-panel">
                    <div class="cache-status">
                        <span id="negative-data-status-text">Checking negative data...</span>
                        <span id="negative-data-file-count" class="cache-count"></span>
                    </div>
                    <div class="cache-actions">
                        <button type="button" id="download-negative-data-btn" class="btn btn-primary">Download
                            Dataset</button>
                    </div>
                </div>
                <p class="cache-description" style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">
                    <strong>Note:</strong> The dataset is approximately 1434MB. Download progress will be shown.
                </p>
            </div>

            <!-- Cache Status Panel - On Home Page -->
            <div class="cache-panel-prominent" id="cache-panel-home">
                <h4>üì¶ Negative Data Cache <span class="required-badge" id="cache-required-badge">Required</span></h4>
                <p class="cache-description">The cache contains pre-processed negative audio samples needed for
                    training. Build it before training your first model.</p>
                <div class="cache-info-panel">
                    <div class="cache-status">
                        <span id="home-cache-status-text">Loading cache info...</span>
                        <span id="home-cache-chunk-count" class="cache-count"></span>
                    </div>
                    <div class="cache-actions">
                        <button type="button" id="home-build-cache-btn" class="btn btn-primary">Build Cache</button>
                        <button type="button" id="home-clear-cache-btn" class="btn btn-danger btn-sm">Clear</button>
                    </div>
                </div>
            </div>


            <div id="models-grid" class="models-grid">
                <!-- Models will be loaded here -->
                <div class="loading-spinner">Loading models...</div>
            </div>
        </section>

        <!-- Training Page: Wizard -->
        <section id="page-train" class="page">
            <div class="wizard">
                <!-- Progress Steps -->
                <div class="wizard-progress">
                    <div class="wizard-step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-label">Wake Word</div>
                    </div>
                    <div class="wizard-step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-label">Record</div>
                    </div>
                    <div class="wizard-step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-label">Training</div>
                    </div>
                    <div class="wizard-step" data-step="4">
                        <div class="step-number">4</div>
                        <div class="step-label">Results</div>
                    </div>
                </div>

                <!-- Step 1: Wake Word Input -->
                <div class="wizard-content" id="step-1">
                    <h2>Choose Your Wake Word</h2>
                    <p class="step-description">
                        Enter a wake word (1-2 words, letters only). Choose something unique and easy to pronounce.
                    </p>

                    <div class="form-group">
                        <label for="wake-word-input">Wake Word</label>
                        <input type="text" id="wake-word-input" placeholder="e.g., Hey Computer" maxlength="12"
                            pattern="[A-Za-z]+( [A-Za-z]+)?" autocomplete="off">
                        <div class="input-hint">4-12 characters, 1-2 words, letters only (e.g., "jarvis" or "hey siri")
                        </div>
                        <div class="input-error" id="wake-word-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="model-type-select">Model Architecture</label>
                        <select id="model-type-select">
                            <option value="ast" selected>AST (Audio Spectrogram Transformer)</option>
                        </select>
                        <div class="input-hint">Uses transfer learning from MIT/ast-finetuned-speech-commands-v2</div>
                    </div>

                    <details class="advanced-options">
                        <summary>Advanced Options</summary>

                        <h4 class="options-section-title">Data Generation</h4>
                        <div class="options-grid">
                            <div class="form-group">
                                <label for="target-positive-samples">Target Positive Samples</label>
                                <input type="number" id="target-positive-samples" value="5000" min="5000" max="8000"
                                    step="500">
                                <div class="input-hint">5000 - Max Negative Chunks samples</div>
                            </div>
                            <div class="form-group">
                                <label for="max-real-negatives">Max Negative Chunks</label>
                                <input type="number" id="max-real-negatives" value="0" min="0" max="47438" step="1000">
                                <div class="input-hint">0 = auto (uses ratio below)</div>
                            </div>
                            <div class="form-group" id="negative-ratio-group">
                                <label for="negative-ratio">Negative:Positive Ratio</label>
                                <select id="negative-ratio">
                                    <option value="1.0">1.0x (minimal)</option>
                                    <option value="1.5">1.5x</option>
                                    <option value="2.0" selected>2.0x (recommended)</option>
                                    <option value="2.5">2.5x</option>
                                    <option value="3.0">3.0x (more robust)</option>
                                </select>
                                <div class="input-hint">Real negatives from cache. 2-3x recommended for good
                                    discrimination.</div>
                            </div>
                            <div class="form-group">
                                <label for="hard-negative-ratio">Hard Negative Ratio</label>
                                <select id="hard-negative-ratio">
                                    <option value="1.0">1.0x (experimental)</option>
                                    <option value="2.0">2.0x (minimal)</option>
                                    <option value="3.0">3.0x</option>
                                    <option value="4.0" selected>4.0x (recommended)</option>
                                    <option value="5.0">5.0x</option>
                                    <option value="6.0">6.0x (maximum discrimination)</option>
                                </select>
                                <div class="input-hint">Similar-sounding words (TTS). 4-6x recommended to prevent false
                                    positives.</div>
                            </div>
                            <div class="form-group checkbox-group">
                                <label>
                                    <input type="checkbox" id="use-tts-positives" checked>
                                    Generate TTS Positives
                                </label>
                                <div class="input-hint">Use text-to-speech for more positive samples</div>
                            </div>
                            <div class="form-group checkbox-group">
                                <label>
                                    <input type="checkbox" id="use-real-negatives" checked>
                                    Use Real Negatives
                                </label>
                                <div class="input-hint">Load from cache (fast) or source files</div>
                            </div>
                            <div class="form-group checkbox-group">
                                <label>
                                    <input type="checkbox" id="use-hard-negatives" checked>
                                    Generate Hard Negatives
                                </label>
                                <div class="input-hint">TTS samples of similar-sounding words (critical for accuracy)
                                </div>
                            </div>
                        </div>

                        <h4 class="options-section-title">Training Parameters</h4>
                        <div class="options-grid">
                            <div class="form-group">
                                <label for="batch-size">Batch Size <span class="tooltip-icon"
                                        data-tooltip="batch-size">?</span></label>
                                <input type="number" id="batch-size" value="32" min="8" max="256">
                                <div class="input-hint">Samples processed together (32 is balanced)</div>
                            </div>
                            <div class="form-group">
                                <label for="num-epochs">Max Epochs <span class="tooltip-icon"
                                        data-tooltip="epochs">?</span></label>
                                <input type="number" id="num-epochs" value="100" min="10" max="500">
                                <div class="input-hint">Maximum training iterations (early stopping may halt sooner)
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="early-stopping">Early Stopping Patience <span class="tooltip-icon"
                                        data-tooltip="early-stop">?</span></label>
                                <input type="number" id="early-stopping" value="8" min="0" max="15" step="1">
                                <div class="input-hint">0=disabled, 1-15 epochs without improvement (8 recommended)
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="learning-rate">Learning Rate <span class="tooltip-icon"
                                        data-tooltip="lr">?</span></label>
                                <input type="number" id="learning-rate" value="0.0001" min="0.000001" max="0.1"
                                    step="0.000001">
                                <div class="input-hint">0.000001-0.1 (0.0001 recommended)</div>
                            </div>
                            <div class="form-group">
                                <label for="dropout">Dropout <span class="tooltip-icon"
                                        data-tooltip="dropout">?</span></label>
                                <input type="number" id="dropout" value="0.5" min="0" max="0.7" step="0.05">
                                <div class="input-hint">Higher dropout prevents overfitting (0.5 recommended)</div>
                            </div>
                            <div class="form-group">
                                <label for="label-smoothing">Label Smoothing <span class="tooltip-icon"
                                        data-tooltip="label-smooth">?</span></label>
                                <input type="number" id="label-smoothing" value="0.1" min="0" max="0.3" step="0.01">
                                <div class="input-hint">Lower values allow more confident predictions (0.1 recommended)
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="mixup-alpha">Mixup Alpha <span class="tooltip-icon"
                                        data-tooltip="mixup">?</span></label>
                                <input type="number" id="mixup-alpha" value="0.5" min="0" max="1.0" step="0.1">
                                <div class="input-hint">More aggressive mixing for robustness (0.5 recommended)</div>
                            </div>
                        </div>

                        <h4 class="options-section-title">Model Enhancements</h4>
                        <div class="options-grid">
                            <div class="form-group checkbox-group">
                                <label>
                                    <input type="checkbox" id="use-focal-loss" checked>
                                    Focal Loss <span class="tooltip-icon" data-tooltip="focal-loss">?</span>
                                </label>
                                <div class="input-hint">Better handling of hard examples (recommended)</div>
                            </div>
                            <div class="form-group">
                                <label for="focal-alpha">Focal Alpha <span class="tooltip-icon"
                                        data-tooltip="focal-alpha">?</span></label>
                                <input type="number" id="focal-alpha" value="0.5" min="0.1" max="0.9" step="0.05">
                                <div class="input-hint">Weight for positive class (0.5 = balanced, higher = favor
                                    positives)</div>
                            </div>
                            <div class="form-group">
                                <label for="focal-gamma">Focal Gamma <span class="tooltip-icon"
                                        data-tooltip="focal-gamma">?</span></label>
                                <input type="number" id="focal-gamma" value="2.0" min="0.5" max="5.0" step="0.5">
                                <div class="input-hint">Higher = more focus on hard examples (2.0 recommended)</div>
                            </div>
                            <div class="form-group checkbox-group">
                                <label>
                                    <input type="checkbox" id="use-attention" checked>
                                    Self-Attention <span class="tooltip-icon" data-tooltip="attention">?</span>
                                </label>
                                <div class="input-hint">Adds attention layer for better discrimination (recommended)
                                </div>
                            </div>
                            <div class="form-group checkbox-group">
                                <label>
                                    <input type="checkbox" id="use-se-block" checked>
                                    SE Block <span class="tooltip-icon" data-tooltip="se-block">?</span>
                                </label>
                                <div class="input-hint">Squeeze-and-Excitation for channel attention</div>
                            </div>
                            <div class="form-group checkbox-group">
                                <label>
                                    <input type="checkbox" id="use-tcn" checked>
                                    TCN Block <span class="tooltip-icon" data-tooltip="tcn">?</span>
                                </label>
                                <div class="input-hint">Temporal Convolutional Network for local patterns</div>
                            </div>
                            <div class="form-group">
                                <label for="classifier-dims">Classifier Layers</label>
                                <select id="classifier-dims">
                                    <option value="256,128">256, 128 (default)</option>
                                    <option value="512,256">512, 256 (deeper)</option>
                                    <option value="512,256,128">512, 256, 128 (deep)</option>
                                    <option value="768,512,256,128">768, 512, 256, 128 (deepest)</option>
                                </select>
                                <div class="input-hint">Deeper classifiers can learn finer distinctions</div>
                            </div>
                        </div>
                    </details>

                    <!-- Technical Explanations Modal -->
                    <div class="tooltip-content" id="tooltip-batch-size">
                        <button class="tooltip-close">&times;</button>
                        <h4>Batch Size</h4>
                        <p><strong>Simple:</strong> How many audio samples the model looks at before updating itself.
                        </p>
                        <p><strong>Technical:</strong> Number of samples per gradient update. Larger batches provide
                            more stable gradients but require more memory. 32 balances speed and stability.</p>
                    </div>
                    <div class="tooltip-content" id="tooltip-epochs">
                        <button class="tooltip-close">&times;</button>
                        <h4>Max Epochs</h4>
                        <p><strong>Simple:</strong> Maximum times the classifier will review all training data.</p>
                        <p><strong>Technical:</strong> With AST transfer learning, the base model is frozen and only the
                            classifier head is trained. Early stopping halts training when validation loss stops
                            improving, so 100 epochs is a safe maximum.</p>
                    </div>
                    <div class="tooltip-content" id="tooltip-lr">
                        <button class="tooltip-close">&times;</button>
                        <h4>Learning Rate</h4>
                        <p><strong>Simple:</strong> How big of steps the model takes when learning.</p>
                        <p><strong>Technical:</strong> A moderate learning rate (0.0005) provides stable training.
                            OneCycleLR scheduler adjusts this dynamically with warmup and cosine annealing.</p>
                    </div>
                    <div class="tooltip-content" id="tooltip-dropout">
                        <button class="tooltip-close">&times;</button>
                        <h4>Dropout</h4>
                        <p><strong>Simple:</strong> Randomly "turns off" parts of the classifier during training to
                            prevent memorization.</p>
                        <p><strong>Technical:</strong> Applied to the classifier head layers. 0.5 means 50% of neurons
                            are dropped, which is aggressive but necessary to prevent overfitting and reduce false
                            positives on similar-sounding words.</p>
                    </div>
                    <div class="tooltip-content" id="tooltip-label-smooth">
                        <button class="tooltip-close">&times;</button>
                        <h4>Label Smoothing</h4>
                        <p><strong>Simple:</strong> Controls how confident the model can be. Lower values = more
                            confident predictions.</p>
                        <p><strong>Technical:</strong> Converts hard labels (0/1) to soft labels (e.g., 0.05/0.95 with
                            0.1 smoothing). A value of 0.1 allows the model to be confident on true wake words while
                            still providing some regularization. Too high (0.25+) can cause the model to miss
                            detections.</p>
                    </div>
                    <div class="tooltip-content" id="tooltip-mixup">
                        <button class="tooltip-close">&times;</button>
                        <h4>Mixup Alpha</h4>
                        <p><strong>Simple:</strong> Blends different audio samples together to create new training
                            examples.</p>
                        <p><strong>Technical:</strong> Creates virtual training examples by linearly interpolating pairs
                            of AST embeddings and their labels. Alpha controls the Beta distribution for mixing ratios.
                        </p>
                    </div>
                    <div class="tooltip-content" id="tooltip-focal-loss">
                        <button class="tooltip-close">&times;</button>
                        <h4>Focal Loss</h4>
                        <p><strong>Simple:</strong> Helps the model focus on difficult examples it gets wrong.</p>
                        <p><strong>Technical:</strong> Focal loss down-weights easy examples and focuses training on
                            hard negatives (similar-sounding words). This is crucial for wake word detection where the
                            model must confidently reject words like "jarv" or "jarvis" when trained on "jarvis".</p>
                    </div>
                    <div class="tooltip-content" id="tooltip-focal-alpha">
                        <button class="tooltip-close">&times;</button>
                        <h4>Focal Alpha</h4>
                        <p><strong>Simple:</strong> How much weight to give positive samples (wake word) vs negatives.
                        </p>
                        <p><strong>Technical:</strong> Class weighting factor in focal loss. Alpha=0.25 gives more
                            weight to negatives (conservative, fewer false positives). Alpha=0.5 is balanced. Alpha>0.5
                            favors positives (higher recall/F1 but may increase false positives). Increase this if F1
                            score is too low.</p>
                    </div>
                    <div class="tooltip-content" id="tooltip-focal-gamma">
                        <button class="tooltip-close">&times;</button>
                        <h4>Focal Gamma</h4>
                        <p><strong>Simple:</strong> How much to focus on hard examples. Higher = more focus.</p>
                        <p><strong>Technical:</strong> The focusing parameter in focal loss: FL(p) = -(1-p)^gamma *
                            log(p). Gamma=0 is standard cross-entropy. Gamma=2 is recommended. Higher values (3-5) focus
                            even more on hard examples but may cause instability.</p>
                    </div>
                    <div class="tooltip-content" id="tooltip-attention">
                        <button class="tooltip-close">&times;</button>
                        <h4>Self-Attention</h4>
                        <p><strong>Simple:</strong> Helps the model focus on the most important parts of the audio.</p>
                        <p><strong>Technical:</strong> Adds a multi-head self-attention layer before the classifier.
                            This allows the model to weigh different parts of the AST embedding differently, potentially
                            improving discrimination between similar-sounding words. Increases trainable parameters by
                            ~2.4M.</p>
                    </div>
                    <div class="tooltip-content" id="tooltip-se-block">
                        <button class="tooltip-close">&times;</button>
                        <h4>SE Block (Squeeze-and-Excitation)</h4>
                        <p><strong>Simple:</strong> Learns which audio features are most important and emphasizes them.
                        </p>
                        <p><strong>Technical:</strong> Channel attention mechanism that models interdependencies between
                            features. Squeezes the embedding through a bottleneck, then uses learned weights to re-scale
                            features. Particularly effective after attention layers for refining feature selection. Adds
                            minimal parameters (~150K).</p>
                    </div>
                    <div class="tooltip-content" id="tooltip-tcn">
                        <button class="tooltip-close">&times;</button>
                        <h4>TCN Block (Temporal Convolutional Network)</h4>
                        <p><strong>Simple:</strong> Captures local patterns in the audio that attention might miss.</p>
                        <p><strong>Technical:</strong> Applies 1D convolutions with residual connections to capture
                            local temporal patterns in the embedding space. Uses dilated convolutions for larger
                            receptive fields. Complements attention by focusing on local structure rather than global
                            relationships. Adds ~1.2M parameters.</p>
                    </div>
                    <div class="tooltip-content" id="tooltip-early-stop">
                        <button class="tooltip-close">&times;</button>
                        <h4>Early Stopping Patience</h4>
                        <p><strong>Simple:</strong> How many epochs to wait without improvement before stopping
                            training.</p>
                        <p><strong>Technical:</strong> Monitors validation loss and stops training if no improvement is
                            seen for the specified number of epochs. Set to 0 to disable. Lower values (5-8) prevent
                            overfitting, higher values (10-15) allow more exploration.</p>
                    </div>

                    <div class="wizard-actions">
                        <button class="btn btn-secondary" id="btn-cancel-train">Cancel</button>
                        <button class="btn btn-primary" id="btn-next-step1">Continue to Recording</button>
                    </div>
                </div>

                <!-- Step 2: Recording -->
                <div class="wizard-content hidden" id="step-2">
                    <h2>Record Your Voice</h2>
                    <p class="step-description">
                        Record yourself saying "<span id="display-wake-word">your wake word</span>"
                        at least once. TTS will generate diverse voice samples automatically.
                    </p>

                    <div class="recording-container">
                        <div class="recording-visualizer">
                            <canvas id="waveform-canvas" width="600" height="100"></canvas>
                        </div>

                        <div class="recording-controls">
                            <button class="btn btn-record" id="btn-record">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <circle cx="12" cy="12" r="6" />
                                </svg>
                                <span>Hold to Record</span>
                            </button>
                        </div>

                        <div class="recordings-list" id="recordings-list">
                            <!-- Recordings will appear here -->
                        </div>

                        <div class="recording-status">
                            <span id="recording-count">0</span> / 5 recordings
                            <span class="recording-hint">(minimum 1 required)</span>
                        </div>
                    </div>

                    <div class="wizard-actions">
                        <button class="btn btn-secondary" id="btn-back-step2">Back</button>
                        <button class="btn btn-primary" id="btn-next-step2" disabled>Start Training</button>
                    </div>
                </div>

                <!-- Step 3: Training Progress -->
                <div class="wizard-content hidden" id="step-3">
                    <h2>Training in Progress</h2>
                    <p class="step-description" id="training-phase">Preparing training data...</p>

                    <div class="training-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progress-percent">0%</span>
                            <span id="elapsed-time" class="elapsed-time"></span>
                        </div>
                    </div>

                    <div class="training-details">
                        <!-- Data Stats Panel -->
                        <div class="data-stats-panel" id="data-stats-panel" style="display: none;">
                            <h3
                                style="margin-bottom: var(--spacing-md); font-size: 1rem; color: var(--text-secondary);">
                                Training Data</h3>
                            <div class="data-stats-grid">
                                <div class="data-stat-item">
                                    <div class="data-stat-value" id="stat-recordings">-</div>
                                    <div class="data-stat-label">Recordings</div>
                                </div>
                                <div class="data-stat-item">
                                    <div class="data-stat-value" id="stat-positive">-</div>
                                    <div class="data-stat-label">Positive Samples</div>
                                </div>
                                <div class="data-stat-item">
                                    <div class="data-stat-value" id="stat-negative">-</div>
                                    <div class="data-stat-label">Negative Samples</div>
                                </div>
                                <div class="data-stat-item">
                                    <div class="data-stat-value" id="stat-train">-</div>
                                    <div class="data-stat-label">Train Set</div>
                                </div>
                                <div class="data-stat-item">
                                    <div class="data-stat-value" id="stat-val">-</div>
                                    <div class="data-stat-label">Val Set</div>
                                </div>
                            </div>
                        </div>

                        <!-- Hyperparameters Panel -->
                        <div class="detail-panel">
                            <h3>Training Configuration</h3>
                            <div class="detail-grid" id="hyperparameters-grid">
                                <div class="detail-item">
                                    <span class="detail-label">Model</span>
                                    <span class="detail-value" id="hp-model-type">AST</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Batch Size</span>
                                    <span class="detail-value" id="hp-batch-size">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Learning Rate</span>
                                    <span class="detail-value" id="hp-learning-rate">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Max Epochs</span>
                                    <span class="detail-value" id="hp-max-epochs">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Dropout</span>
                                    <span class="detail-value" id="hp-dropout">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Label Smoothing</span>
                                    <span class="detail-value" id="hp-label-smoothing">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Mixup Alpha</span>
                                    <span class="detail-value" id="hp-mixup-alpha">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Focal Loss</span>
                                    <span class="detail-value" id="hp-focal-loss">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Focal Gamma</span>
                                    <span class="detail-value" id="hp-focal-gamma">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Self-Attention</span>
                                    <span class="detail-value" id="hp-attention">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">SE Block</span>
                                    <span class="detail-value" id="hp-se-block">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">TCN Block</span>
                                    <span class="detail-value" id="hp-tcn">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Classifier Layers</span>
                                    <span class="detail-value" id="hp-classifier-dims">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Epoch Metrics Panel -->
                        <div class="detail-panel">
                            <h3>Training Metrics</h3>
                            <div class="epoch-info">
                                <span>Epoch <span id="current-epoch">0</span> / <span id="total-epochs">0</span></span>
                            </div>
                            <div class="metrics-grid" id="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-value" id="metric-train-loss">-</div>
                                    <div class="metric-label">Train Loss</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" id="metric-val-loss">-</div>
                                    <div class="metric-label">Val Loss</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" id="metric-val-acc">-</div>
                                    <div class="metric-label">Val Accuracy</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value" id="metric-val-f1">-</div>
                                    <div class="metric-label">Val F1</div>
                                </div>
                            </div>
                        </div>

                        <!-- Training Charts - Side by Side -->
                        <div class="charts-row">
                            <div class="detail-panel chart-panel">
                                <h3>Loss History</h3>
                                <canvas id="training-chart" width="400" height="220"></canvas>
                            </div>
                            <div class="detail-panel chart-panel">
                                <h3>Accuracy & F1 History</h3>
                                <canvas id="accuracy-chart" width="400" height="220"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Results -->
                <div class="wizard-content hidden" id="step-4">
                    <h2>Training Complete!</h2>
                    <p class="step-description">
                        Your wake word model "<span id="result-wake-word">-</span>" has been trained successfully.
                    </p>

                    <div class="results-container">
                        <!-- Performance Summary -->
                        <div class="result-panel">
                            <h3>Performance Summary</h3>
                            <div class="performance-grid">
                                <div class="performance-card">
                                    <div class="perf-value" id="result-accuracy">-</div>
                                    <div class="perf-label">Accuracy</div>
                                </div>
                                <div class="performance-card">
                                    <div class="perf-value" id="result-f1">-</div>
                                    <div class="perf-label">F1 Score</div>
                                </div>
                                <div class="performance-card">
                                    <div class="perf-value" id="result-threshold">-</div>
                                    <div class="perf-label">Threshold</div>
                                </div>
                                <div class="performance-card">
                                    <div class="perf-value" id="result-params">-</div>
                                    <div class="perf-label">Parameters</div>
                                </div>
                            </div>
                        </div>

                        <!-- Training Data Summary -->
                        <div class="result-panel">
                            <h3>Training Data</h3>
                            <div class="detail-grid" id="result-data-grid">
                                <div class="detail-item">
                                    <span class="detail-label">Recordings</span>
                                    <span class="detail-value" id="result-recordings">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Positive Samples</span>
                                    <span class="detail-value" id="result-positive">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Negative Samples</span>
                                    <span class="detail-value" id="result-negative">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Total Epochs</span>
                                    <span class="detail-value" id="result-epochs">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Training Configuration Summary -->
                        <div class="result-panel">
                            <h3>Training Configuration</h3>
                            <div class="detail-grid" id="result-config-grid">
                                <div class="detail-item">
                                    <span class="detail-label">Model</span>
                                    <span class="detail-value" id="result-model-type">AST</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Batch Size</span>
                                    <span class="detail-value" id="result-batch-size">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Learning Rate</span>
                                    <span class="detail-value" id="result-learning-rate">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Dropout</span>
                                    <span class="detail-value" id="result-dropout">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Label Smoothing</span>
                                    <span class="detail-value" id="result-label-smoothing">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Mixup Alpha</span>
                                    <span class="detail-value" id="result-mixup-alpha">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Focal Loss</span>
                                    <span class="detail-value" id="result-focal-loss">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Focal Gamma</span>
                                    <span class="detail-value" id="result-focal-gamma">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Self-Attention</span>
                                    <span class="detail-value" id="result-attention">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Classifier Layers</span>
                                    <span class="detail-value" id="result-classifier-dims">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Training History Charts -->
                        <div class="charts-row">
                            <div class="result-panel chart-panel">
                                <h3>Loss History</h3>
                                <canvas id="result-loss-chart" width="400" height="200"></canvas>
                            </div>
                            <div class="result-panel chart-panel">
                                <h3>Accuracy & F1 History</h3>
                                <canvas id="result-accuracy-chart" width="400" height="200"></canvas>
                            </div>
                        </div>

                        <!-- FAR/FRR Chart -->
                        <div class="result-panel">
                            <h3>Threshold Analysis <span class="tooltip-icon" data-tooltip="threshold">?</span></h3>
                            <canvas id="threshold-chart" width="600" height="250"></canvas>
                            <div class="chart-legend">
                                <span class="legend-item"><span class="legend-color far"></span> FAR (False
                                    Accept)</span>
                                <span class="legend-item"><span class="legend-color frr"></span> FRR (False
                                    Reject)</span>
                            </div>
                            <div class="threshold-explanation">
                                <div class="explanation-card">
                                    <h4>üìä Understanding This Chart</h4>
                                    <p><strong>Simple:</strong> This chart helps you choose how sensitive your wake word
                                        should be.</p>
                                    <ul>
                                        <li><strong>FAR (False Accept Rate):</strong> How often the model incorrectly
                                            triggers on non-wake-word sounds. Lower is better.</li>
                                        <li><strong>FRR (False Reject Rate):</strong> How often the model misses your
                                            actual wake word. Lower is better.</li>
                                        <li><strong>Threshold:</strong> The confidence level required to trigger. Higher
                                            threshold = fewer false triggers but may miss some wake words.</li>
                                    </ul>
                                </div>
                                <div class="explanation-card technical">
                                    <h4>üîß Technical Details</h4>
                                    <p>The optimal threshold is where FAR and FRR curves intersect (Equal Error Rate).
                                        The selected threshold balances:</p>
                                    <ul>
                                        <li><strong>Precision:</strong> Of all detections, how many were correct?</li>
                                        <li><strong>Recall:</strong> Of all actual wake words, how many were detected?
                                        </li>
                                    </ul>
                                    <p>For always-on devices, prioritize low FAR (fewer false triggers). For critical
                                        applications, prioritize low FRR (don't miss wake words).</p>
                                </div>
                            </div>
                        </div>

                        <!-- Training Recordings -->
                        <div class="result-panel">
                            <h3>Training Recordings</h3>
                            <div id="result-recordings-list" class="recordings-list-compact">
                                <span class="loading-text">Loading recordings...</span>
                            </div>
                        </div>

                        <!-- ONNX Export -->
                        <div class="result-panel">
                            <h3>ONNX Export</h3>
                            <div id="result-onnx-status" class="onnx-status">
                                <span class="loading-text">Checking ONNX status...</span>
                            </div>
                        </div>

                        <!-- Download Options -->
                        <div class="result-panel">
                            <h3>Download Model</h3>
                            <div class="download-options">
                                <button class="btn btn-download" id="btn-download-model">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                        <polyline points="7 10 12 15 17 10" />
                                        <line x1="12" y1="15" x2="12" y2="3" />
                                    </svg>
                                    Download Model (.zip)
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-actions">
                        <button class="btn btn-secondary" id="btn-train-another">Train Another</button>
                        <button class="btn btn-primary" id="btn-test-model">Test Model</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Testing Page -->
        <section id="page-test" class="page">
            <div class="page-header">
                <h1>Test Wake Word Detection</h1>
            </div>

            <div class="test-container">
                <!-- Model Selection -->
                <div class="test-panel">
                    <h3>Select Model</h3>
                    <select id="test-model-select" class="model-select">
                        <option value="">-- Select a model --</option>
                    </select>
                    <div class="model-info" id="test-model-info">
                        Select a model to begin testing
                    </div>
                </div>

                <!-- Threshold Control -->
                <div class="test-panel">
                    <h3>Detection Threshold</h3>
                    <div class="threshold-control">
                        <input type="range" id="threshold-slider" min="0" max="100" value="70">
                        <span id="threshold-value">0.70</span>
                    </div>
                    <div class="threshold-hint">
                        Lower = more sensitive, Higher = fewer false positives (recommended: 0.7-0.9)
                    </div>
                </div>

                <!-- Device Selection -->
                <div class="test-panel">
                    <h3>Inference Device</h3>
                    <select id="device-select" class="device-select">
                        <option value="cpu">CPU</option>
                        <option value="cuda">GPU (not available)</option>
                    </select>
                    <div class="device-hint">
                        GPU provides faster inference if available
                    </div>
                </div>

                <!-- Audio Processing Options -->
                <div class="test-panel">
                    <h3>Audio Processing</h3>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="noise-reduction">
                            Enable Noise Reduction
                        </label>
                    </div>
                    <div class="device-hint">
                        Applies spectral gating to reduce background noise before detection. May help in noisy
                        environments but adds slight latency.
                    </div>
                </div>

                <!-- Model Format Selection -->
                <div class="test-panel">
                    <h3>Model Format</h3>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="use-onnx">
                            Use ONNX Model (if available)
                        </label>
                    </div>
                    <div id="onnx-model-status" class="device-hint">
                        Select a model to check ONNX availability
                    </div>
                </div>

                <!-- Detection Visualization -->
                <div class="test-panel detection-panel">
                    <h3>Real-time Detection</h3>
                    <div class="detection-indicator" id="detection-indicator">
                        <div class="indicator-circle"></div>
                        <div class="indicator-text">Say your wake word...</div>
                    </div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidence-fill"></div>
                    </div>
                    <div class="confidence-label">
                        Confidence: <span id="confidence-value">0%</span>
                    </div>
                </div>

                <!-- Controls -->
                <div class="test-panel">
                    <div class="test-controls">
                        <button class="btn btn-primary btn-large" id="btn-start-test" disabled>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                            </svg>
                            Start Listening
                        </button>
                    </div>
                </div>

                <!-- Detection Counter -->
                <div class="test-panel">
                    <h3>Session Counter</h3>
                    <div class="detection-counter-container">
                        <div class="detection-counter" id="detection-counter">0</div>
                        <div class="detection-counter-label">Detections this session</div>
                    </div>
                </div>

                <!-- Detection Log -->
                <div class="test-panel">
                    <h3>Detection Log</h3>
                    <div class="detection-log" id="detection-log">
                        <div class="log-empty">Detections will appear here...</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Scripts -->
    <script src="/js/utils.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/audio.js"></script>
    <script src="/js/charts.js"></script>
    <script src="/js/trainer.js"></script>
    <script src="/js/tester.js"></script>
    <script src="/js/app.js"></script>
</body>

</html>